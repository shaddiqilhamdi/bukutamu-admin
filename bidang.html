<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta name="description" content="Responsive Admin &amp; Dashboard Template based on Bootstrap 5">
	<meta name="author" content="AdminKit">
	<meta name="keywords" content="adminkit, bootstrap, bootstrap 5, admin, dashboard, template, responsive, css, sass, html, theme, front-end, ui kit, web">

	<link rel="preconnect" href="https://fonts.gstatic.com">
	<link rel="shortcut icon" href="img/icons/Logo_pln.png"/>

	<link rel="canonical" href="https://demo-basic.adminkit.io/" />

	<title>Bidang | Buku Tamu</title>

	<!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.3/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.1.0/css/buttons.bootstrap5.min.css">

    <!-- SweetAlert CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/app.css">
</head>

<body>
	<div class="wrapper">
		<nav id="sidebar" class="sidebar js-sidebar">
			<div class="sidebar-content js-simplebar">
				<a class="sidebar-brand" href="dashboard.html">
          				<span class="align-middle">Buku Tamu <br><small>UID Jakarta Raya</small></span>
       				 </a>

				<ul class="sidebar-nav">
					<li class="sidebar-header">
						
					</li>

					<li class="sidebar-item">
						<a class="sidebar-link" href="dashboard.html">
              						<i class="align-middle" data-feather="sliders"></i> <span class="align-middle">Dashboard</span>
           				 	</a>
					</li>

					<li class="sidebar-item">
						<a class="sidebar-link" href="bukutamu.html">
              						<i class="align-middle" data-feather="user"></i> <span class="align-middle">Buku Tamu</span>
            					</a>
					</li>

					
					<li class="sidebar-header">
						Komponen
					</li>

					<li class="sidebar-item">
						<a class="sidebar-link" href="pegawai.html">
              				<i class="align-middle" data-feather="check-square"></i> <span class="align-middle">Pegawai</span>
            			</a>
					</li>
					<li class="sidebar-item">
						<a class="sidebar-link" href="jabatan.html">
              				<i class="align-middle" data-feather="check-square"></i> <span class="align-middle">Jabatan</span>
            			</a>
					</li>
					<li class="sidebar-item active">
						<a class="sidebar-link" href="bidang.html">
              						<i class="align-middle" data-feather="check-square"></i> <span class="align-middle">Bidang</span>
            					</a>
					</li>

					
					<li class="sidebar-header">
						Manajemen User & laporan
					</li>

					<li class="sidebar-item">
						<a class="sidebar-link" href="user.html">
              				<i class="align-middle" data-feather="bar-chart-2"></i> <span class="align-middle">User</span>
           				 </a>
					</li>

					<li class="sidebar-item">
						<a class="sidebar-link" href="userlog.html">
              				<i class="align-middle" data-feather="map"></i> <span class="align-middle">User Log</span>
           				 </a>
					</li>
					<li class="sidebar-item">
						<a class="sidebar-link" href="laporanKunjungan.html">
              				<i class="align-middle" data-feather="file"></i> <span class="align-middle">Laporan Kunjungan</span>
           				 </a>
					</li>
				</ul>

				
			</div>
		</nav>

		<div class="main">
			<nav class="navbar navbar-expand navbar-light navbar-bg">
				<a class="sidebar-toggle js-sidebar-toggle">
          			<i class="hamburger align-self-center"></i>
        		</a>
				<div class="navbar-collapse collapse">
					<ul class="navbar-nav navbar-align">
						<li class="nav-item dropdown">
							<a class="nav-icon dropdown-toggle d-inline-block d-sm-none" href="#" data-bs-toggle="dropdown">
                				<i class="align-middle" data-feather="settings"></i>
              				</a>

							  <a class="nav-link dropdown-toggle d-none d-sm-inline-block" href="#" data-bs-toggle="dropdown">
								<img src="img/avatars/avatar_user.png" class="avatar img-fluid rounded me-1" alt="User_Avatar" />
								<span class="text-dark" id="userNameDisplay">Loading...</span>
							</a>
							
							<div class="dropdown-menu dropdown-menu-end">
								<a class="dropdown-item" href="page/profil.html"><i class="align-middle me-1" data-feather="user"></i> Profile</a>
								<div class="dropdown-divider"></div>
								<a class="dropdown-item" href="#" id="logoutLink">Log out</a>
							</div>
						</li>
					</ul>
				</div>
			</nav>

			<main class="content">
				<div class="container-fluid p-0">
					<div class="row">
						<div class="col-12 col-lg-12 col-xxl-12 d-flex">
							<div class="card flex-fill w-100 " style="padding: 10px 20px;">
								<div class="card-header">
									<a href="#" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#formBidang" data-mode="create">+ Tambah Bidang</a>
								</div>
								<table class="table table-striped table-bordered display nowrap" id="tabelBidang" style="width: 100%;">
								</table>
							</div>
						</div>
					</div>
				</div>

				<div class="modal fade" id="formBidang" tabindex="-1" aria-labelledby="formBidangLabel" aria-hidden="true">
					<div class="modal-dialog">
						<div class="modal-content">
							<div class="modal-header">
								<h5 class="modal-title" id="formBidang">Master Data Bidang</h5>
                				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
							</div>
							<div class="modal-body">
								<form id="formBidang">
									<div class="mb-3">
										<label for="bidang" class="form-label">Bidang</label>
										<input type="text" id="bidang" class="form-control form-control-lg" name="bidang"
											   placeholder="Masukan Nama Bidang" required>
									</div>
									<div class="modal-footer">
										<button type="submit" class="btn btn-primary">Simpan</button>
									</div>
								</form>
						</div>
					</div>
				</div>
			</main>

			<footer class="footer">
				<div class="container-fluid">
					<div class="row text-muted">
						<div class="col-6 text-start">
							<p class="mb-0">
								<a class="text-muted" ><strong>2024</strong></a> - <a class="text-muted" href="#" target="_blank"><strong>PLN UID Jakarta Raya</strong></a>								&copy;
							</p>
						</div>
						<div class="col-6 text-end">
							<ul class="list-inline">
								<li class="list-inline-item">
									<a class="text-muted" href="https://bit.ly/4f6rKNp" target="_blank">Support</a>
								</li>
							</ul>
						</div>
					</div>
				</div>
			</footer>
		</div>
	</div>

	<!-- jQuery -->
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

	<!-- DataTables JS -->
	<script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
	<script src="https://cdn.datatables.net/1.11.3/js/dataTables.bootstrap5.min.js"></script>
	<script src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"></script>

	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>

	<script src="js/app.js"></script>
	<script src="js/auth.js" defer></script>

	<script>
		const token = localStorage.getItem('authToken');
		let table;
	
		$(document).ready(function () {
			// Inisialisasi DataTable
			table = $('#tabelBidang').DataTable({
				ajax: {
					url: `${scriptURL}?type=bidang&token=${token}`,
					dataSrc: 'data'
				},
				columns: [
					{ title: "No.", data: null, width: "5%", render: (data, type, row, meta) => meta.row + 1 },
					{ title: "Bidang", data: "bidang" },
					{
						title: "Aksi",
						data: null,
						width: "8%",
						className: "text-center",
						render: function (data, type, row) {
							return `
								<button class="btn btn-sm btn-warning btn-edit" data-id="${row.id}" data-bidang="${row.bidang}">
									<i class="bi bi-pencil-square"></i>
								</button>
								<button class="btn btn-sm btn-danger btn-delete" data-id="${row.id}">
									<i class="bi bi-trash"></i>
								</button>`;
						}
					}
				],
				responsive: true,
				rowId: 'id'
			});
		});
	
		// Event listener untuk tombol "Tambah"
		document.querySelector('[data-bs-target="#formBidang"]').addEventListener('click', function () {
			document.getElementById('formBidang').setAttribute('data-mode', 'create');
			document.getElementById('formBidang').removeAttribute('data-id');
			const form = document.getElementById('formBidang');
			if (form) {
				form.querySelectorAll('input, textarea, select').forEach(input => {
					input.value = '';
    			});
			}
		});

			
		// Event listener untuk tombol "Edit"
		$('#tabelBidang').on('click', '.btn-edit', function () {
			const id = $(this).data('id');
			const bidang = $(this).data('bidang');
	
			// Isi form dengan data yang dipilih
			document.getElementById('bidang').value = bidang;
			document.getElementById('formBidang').setAttribute('data-mode', 'edit');
			document.getElementById('formBidang').setAttribute('data-id', id);
	
			$('#formBidang').modal('show');
		});
	
		// Event listener untuk tombol "Delete"
		$('#tabelBidang').on('click', '.btn-delete', function () {
			const id = $(this).data('id');
	
			Swal.fire({
				title: 'Yakin ingin menghapus?',
				text: 'Data ini tidak bisa dikembalikan!',
				icon: 'warning',
				showCancelButton: true,
				confirmButtonText: 'Ya, Hapus!',
				cancelButtonText: 'Batal'
			}).then(async (result) => {
				if (result.isConfirmed) {
					showLoading();
	
					const data = new URLSearchParams({
						type: 'bidang',
						action: 'delete',
						id: id,
						token: token
					});
	
					try {
						const response = await fetch(scriptURL, {
							method: 'POST',
							headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
							body: data.toString()
						});
	
						const textResult = await response.text();
						let result;
	
						try {
							result = JSON.parse(textResult);
						} catch (err) {
							Swal.close();
							console.error('Invalid JSON response:', textResult);
							Swal.fire('Error!', 'Respons dari server tidak valid.', 'error');
							return;
						}
	
						if (response.ok && result.success) {
							Swal.fire('Deleted!', 'Data berhasil dihapus.', 'success');
							table.ajax.reload(); // Reload data di tabel
						} else {
							throw new Error(result.message || "Gagal menghapus data");
						}
					} catch (error) {
						Swal.close();
						console.error('Error deleting data:', error.message);
						Swal.fire('Error!', 'Terjadi kesalahan saat menghapus data: ' + error.message, 'error');
					}
				}
			});
		});
	
		// Form submit handler
		document.getElementById("formBidang").addEventListener('submit', async function (e) {
			e.preventDefault();
			const bidang = document.getElementById('bidang').value;
			const mode = this.getAttribute('data-mode');
			const id = this.getAttribute('data-id');
			const action = mode === 'edit' ? 'update' : 'create';
	
			if (!bidang) {
				Swal.fire('Error!', 'Semua field wajib diisi!', 'error');
				return;
			}
	
			showLoading();
	
			const data = new URLSearchParams({ type: 'bidang', action: action, bidang: bidang, token: token });
			if (mode === 'edit') data.append('id', id);
	
			try {
				const response = await fetch(scriptURL, {
					method: 'POST',
					headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
					body: data.toString()
				});
	
				const result = await response.json();
				if (response.ok && result.success) {
					Swal.fire('Success!', result.message, 'success');
					$('#formBidang').modal('hide');
					table.ajax.reload(); // Reload data di tabel
				} else {
					throw new Error(result.message || "Gagal memproses permintaan");
				}
			} catch (error) {
				Swal.fire('Error!', 'Terjadi kesalahan saat mengirim data: ' + error.message, 'error');
			}
		});
	
		// Fungsi untuk menampilkan loading
		function showLoading() {
			Swal.fire({
				title: 'Mohon tunggu...',
				html: 'Sedang memproses permintaan Anda',
				allowOutsideClick: false,
				didOpen: () => {
					Swal.showLoading();
				}
			});
		}
	</script>
		
</body>
</html>
